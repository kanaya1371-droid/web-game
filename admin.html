<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Panel Final</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="assets/style.css">
<link rel="stylesheet" href="assets/layout.css">
</head>

<body>
<div class="card" style="max-width:600px">
  <h2>ðŸ‘® Admin Panel</h2>

  <input id="adminKey" type="password" placeholder="Admin Key">
  <button onclick="login()">Masuk Admin</button>

  <div id="panel" style="display:none;margin-top:16px">
    <h3>Daftar User</h3>
    <ul id="users"></ul>
  </div>
</div>

<script>
const API = "/.netlify/functions/api";
const ADMIN_KEY = "agung137"; // GANTI setelah deploy

function login() {
  if (document.getElementById("adminKey").value !== ADMIN_KEY) {
    alert("Admin key salah");
    return;
  }
  document.getElementById("panel").style.display = "block";
  loadUsers();
}

async function loadUsers() {
  const res = await fetch(API + "/admin/users");
  const users = await res.json();
  const ul = document.getElementById("users");
  ul.innerHTML = "";

  users.forEach(u => {
    ul.innerHTML += `
      <li style="margin-bottom:18px">
        <b>${u.username}</b><br>
        WA: ${u.whatsapp}<br>
        Coin: ${u.coins}<br>
        Status: ${u.status}<br>
        Control Mode: <b>${u.controlMode || "normal"}</b><br><br>

        <!-- OTP -->
        <button onclick="generateOtp('${u.username}','register')">
          OTP Register
        </button>
        <button onclick="generateOtp('${u.username}','reset')">
          OTP Reset
        </button>
        <br><br>

        <!-- CONTROL MODE -->
        <select id="mode-${u.username}">
          <option value="normal">Normal</option>
          <option value="lose">Cepat Lose</option>
          <option value="win">Cepat Win</option>
        </select>

        <button onclick="setMode('${u.username}')">
          Simpan Mode
        </button>
      </li>
    `;
  });
}

/* ===== OTP ===== */
async function generateOtp(username, purpose) {
  const res = await fetch(API + "/admin/generate-otp", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ username, purpose })
  });

  const data = await res.json();
  if (!res.ok) {
    alert(data.msg || "Gagal generate OTP");
    return;
  }

  const waText = encodeURIComponent(
    `Halo ${username}, kode OTP kamu adalah: ${data.otp}`
  );

  window.open(`https://wa.me/${data.whatsapp}?text=${waText}`, "_blank");
}

/* ===== CONTROL MODE ===== */
async function setMode(username) {
  const mode = document.getElementById(`mode-${username}`).value;

  const res = await fetch(API + "/admin/control", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ username, mode })
  });

  const data = await res.json();
  alert(data.msg || "Mode diperbarui");
  loadUsers();
}
</script>
</body>
</html>
