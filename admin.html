<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>

<style>
*{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
body{
  margin:0;
  background:#020617;
  color:#fff;
  min-height:100vh;
}
header{
  padding:14px;
  background:#020617;
  border-bottom:1px solid #1e293b;
  text-align:center;
  font-weight:bold;
}
.container{padding:16px}
input,select,button{
  width:100%;
  padding:12px;
  margin-bottom:10px;
  border-radius:10px;
  border:none;
}
button{
  background:#1abc9c;
  color:#000;
  font-weight:bold;
}
button.red{background:#dc2626;color:#fff}
.card{
  background:#020617;
  border:1px solid #1e293b;
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
}
.user-row{
  border-top:1px solid #1e293b;
  padding-top:10px;
  margin-top:10px;
}
.actions button{
  margin-top:6px;
}
.hidden{display:none}
</style>
</head>

<body>

<header>üëÆ Admin Panel</header>

<div class="container">

<!-- LOGIN ADMIN -->
<div id="loginBox" class="card">
  <h3>Login Admin</h3>
  <input id="adminKey" type="password" placeholder="Admin Key">
  <button onclick="loginAdmin()">Masuk</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

  <div class="card">
    <button class="red" onclick="logout()">Logout Admin</button>
  </div>

  <!-- USER LIST -->
  <div class="card">
    <h3>üë§ Daftar User</h3>
    <div id="userList">Loading...</div>
  </div>

</div>
</div>

<script>
const API = "/.netlify/functions/api";

if(localStorage.getItem("isAdmin")==="true"){
  showDashboard();
}

async function loginAdmin(){
  const key = document.getElementById("adminKey").value.trim();
  if(!key) return alert("Masukkan admin key");

  const res = await fetch(API + "/admin/login",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ key })
  });

  const data = await res.json();
  if(!res.ok) return alert(data.message);

  localStorage.setItem("isAdmin","true");
  showDashboard();
}

function logout(){
  localStorage.removeItem("isAdmin");
  location.reload();
}

async function showDashboard(){
  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("dashboard").classList.remove("hidden");
  loadUsers();
}

async function loadUsers(){
  const res = await fetch(API + "/admin/users");
  const users = await res.json();

  const box = document.getElementById("userList");
  box.innerHTML = "";

  if(!users.length){
    box.innerHTML = "<i>Belum ada user</i>";
    return;
  }

  users.forEach(u=>{
    const div = document.createElement("div");
    div.className = "user-row";
    div.innerHTML = `
      <b>${u.username}</b><br>
      WA: ${u.whatsapp}<br>
      Status: ${u.status}<br>
      Saldo: ${u.saldo}
      <div class="actions">
        <button onclick="genOtp('${u.username}')">üîê Generate OTP</button>
        <button onclick="banUser('${u.username}')">‚õî Ban</button>
        <select onchange="setWin('${u.username}',this.value)">
          <option value="">üé∞ Mode Kemenangan</option>
          <option value="normal">Normal</option>
          <option value="win">Menang</option>
          <option value="lose">Kalah</option>
        </select>
      </div>
    `;
    box.appendChild(div);
  });
}

async function genOtp(username){
  const res = await fetch(API + "/admin/generate-otp",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ username })
  });

  const data = await res.json();
  if(!res.ok) return alert(data.message);

  window.open(data.wa,"_blank");
}

async function banUser(username){
  const t = prompt("Ban berapa menit? (isi 'permanent' untuk selamanya)");
  if(!t) return;

  const res = await fetch(API + "/admin/ban",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ username, minutes: t })
  });

  const data = await res.json();
  alert(data.message);
  loadUsers();
}

function setWin(username,mode){
  alert("Mode kemenangan "+username+" diset: "+mode+" (simulasi)");
}
</script>

</body>
</html>
